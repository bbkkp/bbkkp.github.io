<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="bbkkp"><meta name="copyright" content="bbkkp"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>boost asio beast | bbkkpの折腾日记</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"bbkkp.github.io","root":"/","title":"踏着梦走过时光","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="examplehttps:&#x2F;&#x2F;www.boost.org&#x2F;doc&#x2F;libs&#x2F;1_86_0&#x2F;libs&#x2F;beast&#x2F;doc&#x2F;html&#x2F;beast&#x2F;examples.html 异步服务端12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:type" content="article">
<meta property="og:title" content="boost asio beast">
<meta property="og:url" content="https://bbkkp.github.io/2024/09/18/boost%20asio%20beast.html/index.html">
<meta property="og:site_name" content="bbkkpの折腾日记">
<meta property="og:description" content="examplehttps:&#x2F;&#x2F;www.boost.org&#x2F;doc&#x2F;libs&#x2F;1_86_0&#x2F;libs&#x2F;beast&#x2F;doc&#x2F;html&#x2F;beast&#x2F;examples.html 异步服务端12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-09-18T10:07:22.000Z">
<meta property="article:modified_time" content="2024-09-18T10:07:34.400Z">
<meta property="article:author" content="bbkkp">
<meta property="article:tag" content="c++">
<meta property="article:tag" content="boost">
<meta name="twitter:card" content="summary"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="bbkkp"><img width="96" loading="lazy" src="/images/head.jpg" alt="bbkkp"><span class="site-author-status" title="四季花开">☺️</span></a><div class="site-author-name"><a href="/about/">bbkkp</a></div><span class="site-name">bbkkpの折腾日记</span><sub class="site-subtitle">一个人的世界</sub><div class="site-description">踏着梦走过时光</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">68</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">14</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">40</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><span class="icon iconify" data-icon="ri:rss-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/bbkkp" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="2094921157@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/" title="知乎" target="_blank" style="color:#0084FF"><span class="icon iconify" data-icon="ri:zhihu-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><span class="icon iconify" data-icon="ri:bilibili-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" target="_blank" rel="noopener" href="https://github.com/bbkkp" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#example"><span class="toc-number">1.</span> <span class="toc-text">example</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">1.1.</span> <span class="toc-text">异步服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.2.</span> <span class="toc-text">异步客户端</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://bbkkp.github.io/2024/09/18/boost%20asio%20beast.html/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="bbkkp"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="bbkkpの折腾日记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">boost asio beast</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2024-09-18 18:07:22" itemprop="dateCreated datePublished" datetime="2024-09-18T18:07:22+08:00">2024-09-18</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%BC%80%E6%BA%90%E5%BA%93/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">开源库</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%BC%80%E6%BA%90%E5%BA%93/boost/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">boost</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/c/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">c++</span></a><a class="tag-item" href="/tags/boost/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">boost</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="example"><a href="#example" class="headerlink" title="example"></a>example</h1><p><code>https://www.boost.org/doc/libs/1_86_0/libs/beast/doc/html/beast/examples.html</code></p>
<h2 id="异步服务端"><a href="#异步服务端" class="headerlink" title="异步服务端"></a>异步服务端</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;boost/beast/core.hpp&gt;          // Boost.Beast 核心库，用于处理网络流和缓冲</span><br><span class="line">#include &lt;boost/beast/http.hpp&gt;          // Boost.Beast HTTP 库，用于处理 HTTP 协议</span><br><span class="line">#include &lt;boost/beast/version.hpp&gt;       // Boost.Beast 版本库，提供版本信息</span><br><span class="line">#include &lt;boost/asio/dispatch.hpp&gt;       // Boost.Asio 调度函数，用于将任务调度到执行器</span><br><span class="line">#include &lt;boost/asio/strand.hpp&gt;         // Boost.Asio Strand，用于保证多线程环境下的同步操作</span><br><span class="line">#include &lt;boost/config.hpp&gt;              // Boost 配置选项，提供跨平台支持</span><br><span class="line">#include &lt;algorithm&gt;                     // 标准库中的算法，例如 `std::max`</span><br><span class="line">#include &lt;cstdlib&gt;                       // 标准库中的实用程序函数，如 `std::atoi`</span><br><span class="line">#include &lt;functional&gt;                    // 标准库中的 `std::function` 用于函数对象包装</span><br><span class="line">#include &lt;iostream&gt;                      // 标准输入输出库，用于打印日志和错误信息</span><br><span class="line">#include &lt;memory&gt;                        // 标准库中的智能指针 `std::shared_ptr`</span><br><span class="line">#include &lt;string&gt;                        // 标准库中的字符串类 `std::string`</span><br><span class="line">#include &lt;thread&gt;                        // 标准库中的多线程支持</span><br><span class="line">#include &lt;vector&gt;                        // 标准库中的动态数组容器 `std::vector`</span><br><span class="line"></span><br><span class="line">namespace beast = boost::beast;         // 定义别名 `beast`，表示 `boost::beast` 命名空间</span><br><span class="line">namespace http = beast::http;           // 定义别名 `http`，表示 `boost::beast::http` 命名空间</span><br><span class="line">namespace net = boost::asio;            // 定义别名 `net`，表示 `boost::asio` 命名空间</span><br><span class="line">using tcp = boost::asio::ip::tcp;       // 定义别名 `tcp`，表示 `boost::asio::ip::tcp` 命名空间，用于 TCP 网络编程</span><br><span class="line"></span><br><span class="line">// 根据文件的扩展名返回合理的 MIME 类型</span><br><span class="line">beast::string_view</span><br><span class="line">mime_type(beast::string_view path)</span><br><span class="line">&#123;</span><br><span class="line">    // 进行不区分大小写的字符串比较</span><br><span class="line">    using beast::iequals; </span><br><span class="line"></span><br><span class="line">    // Lambda 函数，提取文件扩展名</span><br><span class="line">    auto const ext = [&amp;path]</span><br><span class="line">    &#123;</span><br><span class="line">        // 找到文件名中最后一个 &#x27;.&#x27; 的位置</span><br><span class="line">        auto const pos = path.rfind(&quot;.&quot;);</span><br><span class="line">        </span><br><span class="line">        // 如果没找到 &#x27;.&#x27;，返回空字符串</span><br><span class="line">        if(pos == beast::string_view::npos)</span><br><span class="line">            return beast::string_view&#123;&#125;;</span><br><span class="line"></span><br><span class="line">        // 返回 &#x27;.&#x27; 后的文件扩展名</span><br><span class="line">        return path.substr(pos);</span><br><span class="line">    &#125;();</span><br><span class="line"></span><br><span class="line">    // 判断文件扩展名并返回对应的 MIME 类型</span><br><span class="line">    if(iequals(ext, &quot;.htm&quot;))  return &quot;text/html&quot;;               // HTML 文件</span><br><span class="line">    if(iequals(ext, &quot;.html&quot;)) return &quot;text/html&quot;;               // HTML 文件</span><br><span class="line">    if(iequals(ext, &quot;.php&quot;))  return &quot;text/html&quot;;               // PHP 文件</span><br><span class="line">    if(iequals(ext, &quot;.css&quot;))  return &quot;text/css&quot;;                // CSS 文件</span><br><span class="line">    if(iequals(ext, &quot;.txt&quot;))  return &quot;text/plain&quot;;              // 纯文本文件</span><br><span class="line">    if(iequals(ext, &quot;.js&quot;))   return &quot;application/javascript&quot;;  // JavaScript 文件</span><br><span class="line">    if(iequals(ext, &quot;.json&quot;)) return &quot;application/json&quot;;        // JSON 数据</span><br><span class="line">    if(iequals(ext, &quot;.xml&quot;))  return &quot;application/xml&quot;;         // XML 数据</span><br><span class="line">    if(iequals(ext, &quot;.swf&quot;))  return &quot;application/x-shockwave-flash&quot;; // Flash 文件</span><br><span class="line">    if(iequals(ext, &quot;.flv&quot;))  return &quot;video/x-flv&quot;;             // FLV 视频文件</span><br><span class="line">    if(iequals(ext, &quot;.png&quot;))  return &quot;image/png&quot;;               // PNG 图片</span><br><span class="line">    if(iequals(ext, &quot;.jpe&quot;))  return &quot;image/jpeg&quot;;              // JPEG 图片</span><br><span class="line">    if(iequals(ext, &quot;.jpeg&quot;)) return &quot;image/jpeg&quot;;              // JPEG 图片</span><br><span class="line">    if(iequals(ext, &quot;.jpg&quot;))  return &quot;image/jpeg&quot;;              // JPEG 图片</span><br><span class="line">    if(iequals(ext, &quot;.gif&quot;))  return &quot;image/gif&quot;;               // GIF 图片</span><br><span class="line">    if(iequals(ext, &quot;.bmp&quot;))  return &quot;image/bmp&quot;;               // BMP 图片</span><br><span class="line">    if(iequals(ext, &quot;.ico&quot;))  return &quot;image/vnd.microsoft.icon&quot;; // ICO 图标文件</span><br><span class="line">    if(iequals(ext, &quot;.tiff&quot;)) return &quot;image/tiff&quot;;              // TIFF 图片</span><br><span class="line">    if(iequals(ext, &quot;.tif&quot;))  return &quot;image/tiff&quot;;              // TIFF 图片</span><br><span class="line">    if(iequals(ext, &quot;.svg&quot;))  return &quot;image/svg+xml&quot;;           // SVG 矢量图</span><br><span class="line">    if(iequals(ext, &quot;.svgz&quot;)) return &quot;image/svg+xml&quot;;           // 压缩的 SVG 矢量图</span><br><span class="line"></span><br><span class="line">    // 默认 MIME 类型是 &quot;application/text&quot;，如果没有匹配的扩展名</span><br><span class="line">    return &quot;application/text&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 将 HTTP 路径拼接到本地文件系统路径上，并返回适合平台的路径</span><br><span class="line">std::string</span><br><span class="line">path_cat(</span><br><span class="line">    beast::string_view base,  // 基础路径</span><br><span class="line">    beast::string_view path)  // 要拼接的相对路径</span><br><span class="line">&#123;</span><br><span class="line">    // 如果基础路径为空，直接返回传入的路径</span><br><span class="line">    if(base.empty())</span><br><span class="line">        return std::string(path);</span><br><span class="line"></span><br><span class="line">    // 将基础路径复制到结果字符串中</span><br><span class="line">    std::string result(base);</span><br><span class="line"></span><br><span class="line">#ifdef BOOST_MSVC  // 如果是 Windows 平台</span><br><span class="line">    // 定义 Windows 的路径分隔符</span><br><span class="line">    char constexpr path_separator = &#x27;\\&#x27;;</span><br><span class="line"></span><br><span class="line">    // 如果基础路径末尾有分隔符，则去掉</span><br><span class="line">    if(result.back() == path_separator)</span><br><span class="line">        result.resize(result.size() - 1);</span><br><span class="line"></span><br><span class="line">    // 将路径拼接到基础路径上</span><br><span class="line">    result.append(path.data(), path.size());</span><br><span class="line"></span><br><span class="line">    // 替换路径中的 &#x27;/&#x27; 为 Windows 路径分隔符 &#x27;\\&#x27;</span><br><span class="line">    for(auto&amp; c : result)</span><br><span class="line">        if(c == &#x27;/&#x27;)</span><br><span class="line">            c = path_separator;</span><br><span class="line"></span><br><span class="line">#else  // POSIX 系统（如 Linux、macOS）</span><br><span class="line">    // 定义 POSIX 系统的路径分隔符</span><br><span class="line">    char constexpr path_separator = &#x27;/&#x27;;</span><br><span class="line"></span><br><span class="line">    // 如果基础路径末尾有分隔符，则去掉</span><br><span class="line">    if(result.back() == path_separator)</span><br><span class="line">        result.resize(result.size() - 1);</span><br><span class="line"></span><br><span class="line">    // 将路径拼接到基础路径上</span><br><span class="line">    result.append(path.data(), path.size());</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    // 返回处理后的完整路径</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 处理传入的 HTTP 请求，返回响应</span><br><span class="line">template &lt;class Body, class Allocator&gt;</span><br><span class="line">http::message_generator</span><br><span class="line">handle_request(</span><br><span class="line">    beast::string_view doc_root,  // 服务器的文档根目录</span><br><span class="line">    http::request&lt;Body, http::basic_fields&lt;Allocator&gt;&gt;&amp;&amp; req)  // HTTP 请求对象</span><br><span class="line">&#123;</span><br><span class="line">    // 生成错误响应的 Lambda 函数，用于构建 `400 Bad Request`</span><br><span class="line">    auto const bad_request =</span><br><span class="line">    [&amp;req](beast::string_view why)  // 接受错误原因</span><br><span class="line">    &#123;</span><br><span class="line">        // 构建一个 `400 Bad Request` 响应</span><br><span class="line">        http::response&lt;http::string_body&gt; res&#123;http::status::bad_request, req.version()&#125;;</span><br><span class="line">        res.set(http::field::server, BOOST_BEAST_VERSION_STRING);  // 设置服务器版本信息</span><br><span class="line">        res.set(http::field::content_type, &quot;text/html&quot;);  // 设置响应的内容类型</span><br><span class="line">        res.keep_alive(req.keep_alive());  // 保持连接状态</span><br><span class="line">        res.body() = std::string(why);  // 将错误信息放入响应 body 中</span><br><span class="line">        res.prepare_payload();  // 准备响应的 payload</span><br><span class="line">        return res;  // 返回响应</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // 生成未找到资源的响应，用于构建 `404 Not Found`</span><br><span class="line">    auto const not_found =</span><br><span class="line">    [&amp;req](beast::string_view target)  // 接受请求的目标</span><br><span class="line">    &#123;</span><br><span class="line">        // 构建一个 `404 Not Found` 响应</span><br><span class="line">        http::response&lt;http::string_body&gt; res&#123;http::status::not_found, req.version()&#125;;</span><br><span class="line">        res.set(http::field::server, BOOST_BEAST_VERSION_STRING);  // 设置服务器版本信息</span><br><span class="line">        res.set(http::field::content_type, &quot;text/html&quot;);  // 设置响应的内容类型</span><br><span class="line">        res.keep_alive(req.keep_alive());  // 保持连接状态</span><br><span class="line">        res.body() = &quot;The resource &#x27;&quot; + std::string(target) + &quot;&#x27; was not found.&quot;;  // 将未找到的目标放入 body</span><br><span class="line">        res.prepare_payload();  // 准备响应的 payload</span><br><span class="line">        return res;  // 返回响应</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // 生成服务器内部错误的响应，用于构建 `500 Internal Server Error`</span><br><span class="line">    auto const server_error =</span><br><span class="line">    [&amp;req](beast::string_view what)  // 接受错误信息</span><br><span class="line">    &#123;</span><br><span class="line">        // 构建一个 `500 Internal Server Error` 响应</span><br><span class="line">        http::response&lt;http::string_body&gt; res&#123;http::status::internal_server_error, req.version()&#125;;</span><br><span class="line">        res.set(http::field::server, BOOST_BEAST_VERSION_STRING);  // 设置服务器版本信息</span><br><span class="line">        res.set(http::field::content_type, &quot;text/html&quot;);  // 设置响应的内容类型</span><br><span class="line">        res.keep_alive(req.keep_alive());  // 保持连接状态</span><br><span class="line">        res.body() = &quot;An error occurred: &#x27;&quot; + std::string(what) + &quot;&#x27;&quot;;  // 将错误信息放入 body</span><br><span class="line">        res.prepare_payload();  // 准备响应的 payload</span><br><span class="line">        return res;  // 返回响应</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // 检查请求方法是否为 GET 或 HEAD，否则返回 `400 Bad Request`</span><br><span class="line">    if( req.method() != http::verb::get &amp;&amp; req.method() != http::verb::head)</span><br><span class="line">        return bad_request(&quot;Unknown HTTP-method&quot;);</span><br><span class="line"></span><br><span class="line">    // 确保请求路径是绝对路径，且不包含 &quot;..&quot;（避免目录遍历攻击）</span><br><span class="line">    if( req.target().empty() || req.target()[0] != &#x27;/&#x27; || req.target().find(&quot;..&quot;) != beast::string_view::npos)</span><br><span class="line">        return bad_request(&quot;Illegal request-target&quot;);</span><br><span class="line"></span><br><span class="line">    // 构建请求文件的路径</span><br><span class="line">    std::string path = path_cat(doc_root, req.target());</span><br><span class="line"></span><br><span class="line">    // 如果请求路径以 &quot;/&quot; 结尾，则默认请求 &quot;index.html&quot;</span><br><span class="line">    if(req.target().back() == &#x27;/&#x27;)</span><br><span class="line">        path.append(&quot;index.html&quot;);</span><br><span class="line"></span><br><span class="line">    // 尝试打开请求的文件</span><br><span class="line">    beast::error_code ec;</span><br><span class="line">    http::file_body::value_type body;</span><br><span class="line">    body.open(path.c_str(), beast::file_mode::scan, ec);</span><br><span class="line"></span><br><span class="line">    // 如果文件不存在，返回 `404 Not Found`</span><br><span class="line">    if(ec == beast::errc::no_such_file_or_directory)</span><br><span class="line">        return not_found(req.target());</span><br><span class="line"></span><br><span class="line">    // 如果打开文件时发生其他错误，返回 `500 Internal Server Error`</span><br><span class="line">    if(ec)</span><br><span class="line">        return server_error(ec.message());</span><br><span class="line"></span><br><span class="line">    // 缓存文件的大小，因为读取文件后我们需要知道它的大小</span><br><span class="line">    auto const size = body.size();</span><br><span class="line"></span><br><span class="line">    // 处理 HEAD 请求，只返回响应头，不返回文件内容</span><br><span class="line">    if(req.method() == http::verb::head)</span><br><span class="line">    &#123;</span><br><span class="line">        // 构建 `200 OK` 响应，但没有正文</span><br><span class="line">        http::response&lt;http::empty_body&gt; res&#123;http::status::ok, req.version()&#125;;</span><br><span class="line">        res.set(http::field::server, BOOST_BEAST_VERSION_STRING);  // 设置服务器版本信息</span><br><span class="line">        res.set(http::field::content_type, mime_type(path));  // 设置内容类型</span><br><span class="line">        res.content_length(size);  // 设置文件大小</span><br><span class="line">        res.keep_alive(req.keep_alive());  // 保持连接状态</span><br><span class="line">        return res;  // 返回响应</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 处理 GET 请求，返回文件内容</span><br><span class="line">    http::response&lt;http::file_body&gt; res&#123;</span><br><span class="line">        std::piecewise_construct,</span><br><span class="line">        std::make_tuple(std::move(body)),  // 将文件体作为响应内容</span><br><span class="line">        std::make_tuple(http::status::ok, req.version())&#125;;  // 响应状态为 `200 OK`</span><br><span class="line">    res.set(http::field::server, BOOST_BEAST_VERSION_STRING);  // 设置服务器版本信息</span><br><span class="line">    res.set(http::field::content_type, mime_type(path));  // 设置内容类型</span><br><span class="line">    res.content_length(size);  // 设置文件大小</span><br><span class="line">    res.keep_alive(req.keep_alive());  // 保持连接状态</span><br><span class="line">    return res;  // 返回响应</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// 报告失败的错误信息</span><br><span class="line">void</span><br><span class="line">fail(beast::error_code ec, char const* what)</span><br><span class="line">&#123;</span><br><span class="line">    // 打印错误信息到标准错误输出</span><br><span class="line">    std::cerr &lt;&lt; what &lt;&lt; &quot;: &quot; &lt;&lt; ec.message() &lt;&lt; &quot;\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 处理 HTTP 连接的会话类，每个客户端连接创建一个 session 实例</span><br><span class="line">class session : public std::enable_shared_from_this&lt;session&gt;</span><br><span class="line">&#123;</span><br><span class="line">    beast::tcp_stream stream_;  // Beast 的 TCP 流，负责管理与客户端的网络连接</span><br><span class="line">    beast::flat_buffer buffer_;  // 缓冲区，用于存储从客户端读取的数据</span><br><span class="line">    std::shared_ptr&lt;std::string const&gt; doc_root_;  // 服务器的文档根目录</span><br><span class="line">    http::request&lt;http::string_body&gt; req_;  // HTTP 请求对象</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    // 构造函数，接收一个 TCP 套接字和文档根目录</span><br><span class="line">    session(</span><br><span class="line">        tcp::socket&amp;&amp; socket,  // 客户端的 TCP 套接字</span><br><span class="line">        std::shared_ptr&lt;std::string const&gt; const&amp; doc_root)  // 文档根目录的共享指针</span><br><span class="line">        : stream_(std::move(socket))  // 将套接字转换为 TCP 流</span><br><span class="line">        , doc_root_(doc_root)  // 初始化文档根目录</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 启动异步操作，处理客户端的请求</span><br><span class="line">    void</span><br><span class="line">    run()</span><br><span class="line">    &#123;</span><br><span class="line">        // 确保在 strand 内执行异步操作，防止多线程环境下的竞争</span><br><span class="line">        net::dispatch(stream_.get_executor(),</span><br><span class="line">                      beast::bind_front_handler(</span><br><span class="line">                          &amp;session::do_read,  // 绑定 `do_read` 函数</span><br><span class="line">                          shared_from_this()));  // 使用 `shared_from_this` 获取共享指针，确保对象的生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 异步读取客户端的请求</span><br><span class="line">    void</span><br><span class="line">    do_read()</span><br><span class="line">    &#123;</span><br><span class="line">        // 每次读取请求前，都将请求对象重置为空，避免数据污染</span><br><span class="line">        req_ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        // 设置超时时间，防止客户端长时间不响应导致资源占用</span><br><span class="line">        stream_.expires_after(std::chrono::seconds(30));</span><br><span class="line"></span><br><span class="line">        // 异步读取 HTTP 请求到缓冲区和请求对象中</span><br><span class="line">        http::async_read(stream_, buffer_, req_,</span><br><span class="line">            beast::bind_front_handler(</span><br><span class="line">                &amp;session::on_read,  // 读取完成后调用 `on_read` 函数</span><br><span class="line">                shared_from_this()));  // 使用 `shared_from_this` 确保对象生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 处理读取完成后的操作</span><br><span class="line">    void</span><br><span class="line">    on_read(</span><br><span class="line">        beast::error_code ec,  // 错误代码对象</span><br><span class="line">        std::size_t bytes_transferred)  // 实际传输的字节数</span><br><span class="line">    &#123;</span><br><span class="line">        // 忽略未使用的参数，防止编译警告</span><br><span class="line">        boost::ignore_unused(bytes_transferred);</span><br><span class="line"></span><br><span class="line">        // 如果错误代码表示客户端关闭了连接，调用 `do_close` 函数关闭连接</span><br><span class="line">        if(ec == http::error::end_of_stream)</span><br><span class="line">            return do_close();</span><br><span class="line"></span><br><span class="line">        // 如果出现其他错误，报告错误</span><br><span class="line">        if(ec)</span><br><span class="line">            return fail(ec, &quot;read&quot;);</span><br><span class="line"></span><br><span class="line">        // 处理请求并发送响应</span><br><span class="line">        send_response(</span><br><span class="line">            handle_request(*doc_root_, std::move(req_)));  // 调用 `handle_request` 处理请求</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 发送处理后的响应</span><br><span class="line">    void</span><br><span class="line">    send_response(http::message_generator&amp;&amp; msg)  // 接收处理好的 HTTP 响应</span><br><span class="line">    &#123;</span><br><span class="line">        bool keep_alive = msg.keep_alive();  // 判断是否需要保持连接</span><br><span class="line"></span><br><span class="line">        // 异步写入响应</span><br><span class="line">        beast::async_write(</span><br><span class="line">            stream_,  // TCP 流</span><br><span class="line">            std::move(msg),  // 移动消息生成器</span><br><span class="line">            beast::bind_front_handler(</span><br><span class="line">                &amp;session::on_write,  // 写入完成后调用 `on_write` 函数</span><br><span class="line">                shared_from_this(), keep_alive));  // 传递 keep_alive 标志</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 处理响应写入完成后的操作</span><br><span class="line">    void</span><br><span class="line">    on_write(</span><br><span class="line">        bool keep_alive,  // 是否保持连接</span><br><span class="line">        beast::error_code ec,  // 错误代码对象</span><br><span class="line">        std::size_t bytes_transferred)  // 实际传输的字节数</span><br><span class="line">    &#123;</span><br><span class="line">        // 忽略未使用的参数，防止编译警告</span><br><span class="line">        boost::ignore_unused(bytes_transferred);</span><br><span class="line"></span><br><span class="line">        // 如果出现错误，报告错误</span><br><span class="line">        if(ec)</span><br><span class="line">            return fail(ec, &quot;write&quot;);</span><br><span class="line"></span><br><span class="line">        // 如果不需要保持连接，关闭连接</span><br><span class="line">        if(!keep_alive)</span><br><span class="line">        &#123;</span><br><span class="line">            return do_close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 如果需要保持连接，继续读取下一个请求</span><br><span class="line">        do_read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 关闭客户端连接</span><br><span class="line">    void</span><br><span class="line">    do_close()</span><br><span class="line">    &#123;</span><br><span class="line">        // 发送 TCP 连接关闭信号</span><br><span class="line">        beast::error_code ec;</span><br><span class="line">        stream_.socket().shutdown(tcp::socket::shutdown_send, ec);  // 优雅关闭 TCP 连接</span><br><span class="line"></span><br><span class="line">        // 此时，连接已经优雅地关闭</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// 负责接收传入连接并启动新会话的类</span><br><span class="line">class listener : public std::enable_shared_from_this&lt;listener&gt;</span><br><span class="line">&#123;</span><br><span class="line">    net::io_context&amp; ioc_;  // 引用 I/O 上下文，负责管理异步操作</span><br><span class="line">    tcp::acceptor acceptor_;  // TCP 接收器，监听传入的连接</span><br><span class="line">    std::shared_ptr&lt;std::string const&gt; doc_root_;  // 文档根目录</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    // 构造函数，初始化 I/O 上下文、TCP 接收器和文档根目录</span><br><span class="line">    listener(</span><br><span class="line">        net::io_context&amp; ioc,  // I/O 上下文对象</span><br><span class="line">        tcp::endpoint endpoint,  // 监听的 TCP 端点（IP 地址和端口）</span><br><span class="line">        std::shared_ptr&lt;std::string const&gt; const&amp; doc_root)  // 文档根目录</span><br><span class="line">        : ioc_(ioc)  // 初始化 I/O 上下文</span><br><span class="line">        , acceptor_(net::make_strand(ioc))  // 初始化 TCP 接收器，并与 strand 关联</span><br><span class="line">        , doc_root_(doc_root)  // 初始化文档根目录</span><br><span class="line">    &#123;</span><br><span class="line">        beast::error_code ec;</span><br><span class="line"></span><br><span class="line">        // 打开接收器，准备接受新的连接</span><br><span class="line">        acceptor_.open(endpoint.protocol(), ec);</span><br><span class="line">        if(ec)</span><br><span class="line">        &#123;</span><br><span class="line">            fail(ec, &quot;open&quot;);  // 如果打开失败，报告错误</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 允许地址重用，避免绑定端口时地址冲突</span><br><span class="line">        acceptor_.set_option(net::socket_base::reuse_address(true), ec);</span><br><span class="line">        if(ec)</span><br><span class="line">        &#123;</span><br><span class="line">            fail(ec, &quot;set_option&quot;);  // 如果设置选项失败，报告错误</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 绑定服务器地址和端口</span><br><span class="line">        acceptor_.bind(endpoint, ec);</span><br><span class="line">        if(ec)</span><br><span class="line">        &#123;</span><br><span class="line">            fail(ec, &quot;bind&quot;);  // 如果绑定失败，报告错误</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 开始监听连接</span><br><span class="line">        acceptor_.listen(net::socket_base::max_listen_connections, ec);</span><br><span class="line">        if(ec)</span><br><span class="line">        &#123;</span><br><span class="line">            fail(ec, &quot;listen&quot;);  // 如果监听失败，报告错误</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 开始接受传入的连接</span><br><span class="line">    void</span><br><span class="line">    run()</span><br><span class="line">    &#123;</span><br><span class="line">        do_accept();  // 调用 `do_accept` 开始接受连接</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    // 异步接受传入连接</span><br><span class="line">    void</span><br><span class="line">    do_accept()</span><br><span class="line">    &#123;</span><br><span class="line">        // 每个新的连接都在独立的 strand 中执行</span><br><span class="line">        acceptor_.async_accept(</span><br><span class="line">            net::make_strand(ioc_),  // 使用 strand 来保证线程安全</span><br><span class="line">            beast::bind_front_handler(</span><br><span class="line">                &amp;listener::on_accept,  // 绑定 `on_accept` 处理连接</span><br><span class="line">                shared_from_this()));  // 使用 `shared_from_this` 确保对象生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 处理接受到的连接</span><br><span class="line">    void</span><br><span class="line">    on_accept(beast::error_code ec, tcp::socket socket)  // 接收到的 TCP 套接字</span><br><span class="line">    &#123;</span><br><span class="line">        if(ec)</span><br><span class="line">        &#123;</span><br><span class="line">            fail(ec, &quot;accept&quot;);  // 如果接受失败，报告错误</span><br><span class="line">            return;  // 防止进入无限循环</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            // 创建新的 session（会话）对象，并启动它来处理客户端连接</span><br><span class="line">            std::make_shared&lt;session&gt;(std::move(socket), doc_root_)-&gt;run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 接受下一个连接</span><br><span class="line">        do_accept();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// 程序入口：主函数</span><br><span class="line">int main(int argc, char* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    // 检查命令行参数，确保输入的参数数量正确</span><br><span class="line">    if (argc != 5)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt;</span><br><span class="line">            &quot;Usage: http-server-async &lt;address&gt; &lt;port&gt; &lt;doc_root&gt; &lt;threads&gt;\n&quot; &lt;&lt;  // 打印使用说明</span><br><span class="line">            &quot;Example:\n&quot; &lt;&lt;</span><br><span class="line">            &quot;    http-server-async 0.0.0.0 8080 . 1\n&quot;;  // 示例命令</span><br><span class="line">        return EXIT_FAILURE;  // 参数数量错误，退出程序</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 从命令行获取服务器的 IP 地址</span><br><span class="line">    auto const address = net::ip::make_address(argv[1]);</span><br><span class="line"></span><br><span class="line">    // 从命令行获取服务器的端口号，并转换为无符号短整型</span><br><span class="line">    auto const port = static_cast&lt;unsigned short&gt;(std::atoi(argv[2]));</span><br><span class="line"></span><br><span class="line">    // 获取文档根目录的路径，并存储在共享指针中</span><br><span class="line">    auto const doc_root = std::make_shared&lt;std::string&gt;(argv[3]);</span><br><span class="line"></span><br><span class="line">    // 获取线程数量，至少为 1</span><br><span class="line">    auto const threads = std::max&lt;int&gt;(1, std::atoi(argv[4]));</span><br><span class="line"></span><br><span class="line">    // 创建 I/O 上下文，指定线程数量</span><br><span class="line">    net::io_context ioc&#123;threads&#125;;</span><br><span class="line"></span><br><span class="line">    // 创建并启动监听器，监听传入的连接</span><br><span class="line">    std::make_shared&lt;listener&gt;(</span><br><span class="line">        ioc,  // I/O 上下文</span><br><span class="line">        tcp::endpoint&#123;address, port&#125;,  // 监听的 IP 地址和端口</span><br><span class="line">        doc_root)-&gt;run();  // 启动监听器</span><br><span class="line"></span><br><span class="line">    // 创建线程池，用于运行 I/O 服务</span><br><span class="line">    std::vector&lt;std::thread&gt; v;</span><br><span class="line">    v.reserve(threads - 1);  // 预留 (threads - 1) 个线程</span><br><span class="line"></span><br><span class="line">    // 为每个线程创建并运行一个 I/O 服务线程</span><br><span class="line">    for(auto i = threads - 1; i &gt; 0; --i)</span><br><span class="line">        v.emplace_back(</span><br><span class="line">        [&amp;ioc]  // 捕获 I/O 上下文</span><br><span class="line">        &#123;</span><br><span class="line">            ioc.run();  // 在当前线程中运行 I/O 服务</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    ioc.run();  // 主线程也运行 I/O 服务</span><br><span class="line"></span><br><span class="line">    return EXIT_SUCCESS;  // 程序成功结束</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="异步客户端"><a href="#异步客户端" class="headerlink" title="异步客户端"></a>异步客户端</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;boost/beast/core.hpp&gt;          // Boost.Beast 核心库，用于处理 I/O、流和缓冲区</span><br><span class="line">#include &lt;boost/beast/http.hpp&gt;          // Boost.Beast HTTP 库，用于处理 HTTP 协议的请求和响应</span><br><span class="line">#include &lt;boost/beast/version.hpp&gt;       // Boost.Beast 版本信息</span><br><span class="line">#include &lt;boost/asio/strand.hpp&gt;         // Boost.Asio strand 用于同步多线程任务</span><br><span class="line">#include &lt;cstdlib&gt;                       // C++ 标准库中的实用程序函数，如 `std::exit` 和 `std::atoi`</span><br><span class="line">#include &lt;functional&gt;                    // 标准库中的函数对象包装器，如 `std::bind` 和 `std::function`</span><br><span class="line">#include &lt;iostream&gt;                      // 标准输入输出流，用于输出到控制台</span><br><span class="line">#include &lt;memory&gt;                        // 智能指针，如 `std::shared_ptr`</span><br><span class="line">#include &lt;string&gt;                        // 标准 C++ 字符串类</span><br><span class="line"></span><br><span class="line">namespace beast = boost::beast;          // 简化 `boost::beast` 命名空间为 `beast`</span><br><span class="line">namespace http = beast::http;            // 简化 `boost::beast::http` 命名空间为 `http`</span><br><span class="line">namespace net = boost::asio;             // 简化 `boost::asio` 命名空间为 `net`</span><br><span class="line">using tcp = boost::asio::ip::tcp;        // 简化 `boost::asio::ip::tcp` 命名空间为 `tcp`</span><br><span class="line"></span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// 打印错误信息的辅助函数</span><br><span class="line">void</span><br><span class="line">fail(beast::error_code ec, char const* what)</span><br><span class="line">&#123;</span><br><span class="line">    // 输出错误信息和错误码到标准错误流</span><br><span class="line">    std::cerr &lt;&lt; what &lt;&lt; &quot;: &quot; &lt;&lt; ec.message() &lt;&lt; &quot;\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 一个异步 HTTP GET 客户端类，用于发送 HTTP 请求并打印响应</span><br><span class="line">class session : public std::enable_shared_from_this&lt;session&gt;</span><br><span class="line">&#123;</span><br><span class="line">    // 成员变量</span><br><span class="line">    tcp::resolver resolver_;              // TCP 解析器，用于将主机名解析为 IP 地址</span><br><span class="line">    beast::tcp_stream stream_;            // Boost.Beast 的 TCP 流，用于管理 TCP 连接</span><br><span class="line">    beast::flat_buffer buffer_;           // 扁平缓冲区，用于存储从服务器读取的数据（在读取之间必须保持有效）</span><br><span class="line">    http::request&lt;http::empty_body&gt; req_; // HTTP 请求对象</span><br><span class="line">    http::response&lt;http::string_body&gt; res_; // HTTP 响应对象</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    // 构造函数，接收一个 `io_context`，并初始化 resolver 和 stream</span><br><span class="line">    explicit</span><br><span class="line">    session(net::io_context&amp; ioc)</span><br><span class="line">        : resolver_(net::make_strand(ioc))  // 初始化 resolver，确保在 strand 中执行异步任务，保证线程安全</span><br><span class="line">        , stream_(net::make_strand(ioc))    // 初始化 stream，同样在 strand 中执行</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 开始异步操作，发送 HTTP GET 请求</span><br><span class="line">    void</span><br><span class="line">    run(</span><br><span class="line">        char const* host,     // 要请求的主机名</span><br><span class="line">        char const* port,     // 要请求的端口号</span><br><span class="line">        char const* target,   // 请求目标路径（例如 &quot;/&quot;）</span><br><span class="line">        int version)          // HTTP 版本（1.0 或 1.1）</span><br><span class="line">    &#123;</span><br><span class="line">        // 设置 HTTP GET 请求的版本、方法和目标路径</span><br><span class="line">        req_.version(version);                // 设置 HTTP 版本</span><br><span class="line">        req_.method(http::verb::get);         // 设置 HTTP 方法为 GET</span><br><span class="line">        req_.target(target);                  // 设置请求目标路径（通常是 URL 中的路径部分）</span><br><span class="line">        req_.set(http::field::host, host);    // 设置请求头中的主机名</span><br><span class="line">        req_.set(http::field::user_agent, BOOST_BEAST_VERSION_STRING); // 设置用户代理，通常为应用程序的标识符</span><br><span class="line"></span><br><span class="line">        // 解析主机名，启动异步 DNS 查询，解析主机名和端口号</span><br><span class="line">        resolver_.async_resolve(</span><br><span class="line">            host,                             // 要解析的主机名</span><br><span class="line">            port,                             // 要解析的端口号</span><br><span class="line">            beast::bind_front_handler(        // 绑定回调函数，处理解析完成后的操作</span><br><span class="line">                &amp;session::on_resolve,         // 解析完成后调用的函数</span><br><span class="line">                shared_from_this()));         // 使用 shared_from_this 保持当前对象的生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析完成后的回调函数</span><br><span class="line">    void</span><br><span class="line">    on_resolve(</span><br><span class="line">        beast::error_code ec,                     // 错误代码对象</span><br><span class="line">        tcp::resolver::results_type results)      // 解析后的结果列表</span><br><span class="line">    &#123;</span><br><span class="line">        // 如果解析过程中出现错误，打印错误信息并返回</span><br><span class="line">        if(ec)</span><br><span class="line">            return fail(ec, &quot;resolve&quot;);</span><br><span class="line"></span><br><span class="line">        // 设置超时时间为 30 秒</span><br><span class="line">        stream_.expires_after(std::chrono::seconds(30));</span><br><span class="line"></span><br><span class="line">        // 异步连接到解析后的 IP 地址</span><br><span class="line">        stream_.async_connect(</span><br><span class="line">            results,                               // 解析结果（可能包含多个 IP 地址）</span><br><span class="line">            beast::bind_front_handler(             // 绑定回调函数，处理连接完成后的操作</span><br><span class="line">                &amp;session::on_connect,              // 连接完成后调用的函数</span><br><span class="line">                shared_from_this()));              // 使用 shared_from_this 保持当前对象的生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 连接完成后的回调函数</span><br><span class="line">    void</span><br><span class="line">    on_connect(beast::error_code ec, tcp::resolver::results_type::endpoint_type)</span><br><span class="line">    &#123;</span><br><span class="line">        // 如果连接过程中出现错误，打印错误信息并返回</span><br><span class="line">        if(ec)</span><br><span class="line">            return fail(ec, &quot;connect&quot;);</span><br><span class="line"></span><br><span class="line">        // 设置超时时间为 30 秒</span><br><span class="line">        stream_.expires_after(std::chrono::seconds(30));</span><br><span class="line"></span><br><span class="line">        // 异步发送 HTTP 请求</span><br><span class="line">        http::async_write(stream_, req_,        // 发送的 TCP 流和 HTTP 请求对象</span><br><span class="line">            beast::bind_front_handler(          // 绑定回调函数，处理写操作完成后的操作</span><br><span class="line">                &amp;session::on_write,             // 写操作完成后调用的函数</span><br><span class="line">                shared_from_this()));           // 使用 shared_from_this 保持当前对象的生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 写入操作完成后的回调函数</span><br><span class="line">    void</span><br><span class="line">    on_write(</span><br><span class="line">        beast::error_code ec,                    // 错误代码对象</span><br><span class="line">        std::size_t bytes_transferred)           // 实际写入的字节数</span><br><span class="line">    &#123;</span><br><span class="line">        // 忽略未使用的参数，防止编译警告</span><br><span class="line">        boost::ignore_unused(bytes_transferred);</span><br><span class="line"></span><br><span class="line">        // 如果写入过程中出现错误，打印错误信息并返回</span><br><span class="line">        if(ec)</span><br><span class="line">            return fail(ec, &quot;write&quot;);</span><br><span class="line">        </span><br><span class="line">        // 异步读取 HTTP 响应</span><br><span class="line">        http::async_read(stream_, buffer_, res_,   // 从 TCP 流中读取，读取的数据放入缓冲区，解析后的响应放入 res_</span><br><span class="line">            beast::bind_front_handler(             // 绑定回调函数，处理读取完成后的操作</span><br><span class="line">                &amp;session::on_read,                 // 读取完成后调用的函数</span><br><span class="line">                shared_from_this()));              // 使用 shared_from_this 保持当前对象的生命周期</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 读取操作完成后的回调函数</span><br><span class="line">    void</span><br><span class="line">    on_read(</span><br><span class="line">        beast::error_code ec,                    // 错误代码对象</span><br><span class="line">        std::size_t bytes_transferred)           // 实际读取的字节数</span><br><span class="line">    &#123;</span><br><span class="line">        // 忽略未使用的参数，防止编译警告</span><br><span class="line">        boost::ignore_unused(bytes_transferred);</span><br><span class="line"></span><br><span class="line">        // 如果读取过程中出现错误，打印错误信息并返回</span><br><span class="line">        if(ec)</span><br><span class="line">            return fail(ec, &quot;read&quot;);</span><br><span class="line"></span><br><span class="line">        // 输出读取到的 HTTP 响应到控制台</span><br><span class="line">        std::cout &lt;&lt; res_ &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        // 优雅关闭 TCP 连接</span><br><span class="line">        stream_.socket().shutdown(tcp::socket::shutdown_both, ec);</span><br><span class="line"></span><br><span class="line">        // 如果发生其他错误且不是连接未建立的错误，报告错误</span><br><span class="line">        if(ec &amp;&amp; ec != beast::errc::not_connected)</span><br><span class="line">            return fail(ec, &quot;shutdown&quot;);</span><br><span class="line"></span><br><span class="line">        // 到这里连接已优雅地关闭</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// 主函数</span><br><span class="line">int main(int argc, char** argv)</span><br><span class="line">&#123;</span><br><span class="line">    // 检查命令行参数，确保参数数量正确</span><br><span class="line">    if(argc != 4 &amp;&amp; argc != 5)</span><br><span class="line">    &#123;</span><br><span class="line">        // 如果参数不正确，打印使用说明并退出</span><br><span class="line">        std::cerr &lt;&lt;</span><br><span class="line">            &quot;Usage: http-client-async &lt;host&gt; &lt;port&gt; &lt;target&gt; [&lt;HTTP version: 1.0 or 1.1(default)&gt;]\n&quot; &lt;&lt;  // 使用说明</span><br><span class="line">            &quot;Example:\n&quot; &lt;&lt;</span><br><span class="line">            &quot;    http-client-async www.example.com 80 /\n&quot; &lt;&lt;   // 示例用法</span><br><span class="line">            &quot;    http-client-async www.example.com 80 / 1.0\n&quot;; // 示例用法（指定 HTTP 版本）</span><br><span class="line">        return EXIT_FAILURE;  // 参数错误，退出程序</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 从命令行参数中提取主机名、端口号和目标路径</span><br><span class="line">    auto const host = argv[1];      // 主机名</span><br><span class="line">    auto const port = argv[2];      // 端口号</span><br><span class="line">    auto const target = argv[3];    // 请求目标路径</span><br><span class="line"></span><br><span class="line">    // 判断是否指定了 HTTP 版本，默认使用 1.1，若命令行参数是 1.0，则使用 HTTP 1.0</span><br><span class="line">    int version = argc == 5 &amp;&amp; !std::strcmp(&quot;1.0&quot;, argv[4]) ? 10 : 11;</span><br><span class="line"></span><br><span class="line">    // 创建 Boost.Asio 的 I/O 上下文对象，管理异步操作</span><br><span class="line">    net::io_context ioc;</span><br><span class="line"></span><br><span class="line">    // 启动异步 HTTP GET 操作，创建 session 对象并调用 run 方法</span><br><span class="line">    std::make_shared&lt;session&gt;(ioc)-&gt;run(host, port, target, version);</span><br><span class="line"></span><br><span class="line">    // 运行 I/O 服务，直到所有异步操作完成</span><br><span class="line">    ioc.run();</span><br><span class="line"></span><br><span class="line">    // 程序成功结束</span><br><span class="line">    return EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>bbkkp</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://bbkkp.github.io/2024/09/18/boost%20asio%20beast.html/" title="boost asio beast">https://bbkkp.github.io/2024/09/18/boost%20asio%20beast.html/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/09/18/boost%20asio%20IOThreadPool.html/" rel="next" title="boost asio IOThreadPool"><span class="post-nav-text">boost asio IOThreadPool</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2024 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> bbkkp</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div><div class="live-time"><span>感谢陪伴</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2024-08-30T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();
</script></div><div class="footer-custom-text"><a href="yourLink" rel="noopener" target="_blank">学就完了</a></div><div class="footer-support"><span>本站由</span><a class="footer-support-logo" href="https://www.rainyun.com/YeMeng_" target="blank" title="雨云"><img height="30" src="https://cn-sy1.rains3.com/yemenghexo/rainyunlogo.png" alt="雨云"></a><span>提供 对象存储 服务</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body></html>